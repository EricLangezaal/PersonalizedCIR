#!/bin/bash

#SBATCH --partition=gpu
#SBATCH --gpus=1
#SBATCH --job-name=test_ikat_dense_prompt1
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=18
#SBATCH --time=03:00:00
#SBATCH --output=outputs/batch_test_ikat_dense_prompt1_%A.out

# Load necessary modules
module purge
module load 2024
module load Anaconda3/2024.06-1

# Activate the Conda environment
source activate ir2

# Define the input types, number of runs, shot versions, prompts, and years
TYPES=("human" "All" "automatic" "LLM" "None" "SAR")
RUNS=(1 2 3 4 5)
SHOT_VERSIONS=("0shot" "1shot" "3shot" "5shot")
PROMPTS=("prompt1")
YEARS=(2024)

# Loop over each year
for YEAR in "${YEARS[@]}"; do
  echo "Starting processing for Year: $YEAR"

  # Loop over types, runs, and shot versions
  for TYPE in "${TYPES[@]}"; do
    for RUN in "${RUNS[@]}"; do
      if [ "$TYPE" == "LLM" ] || [ "$TYPE" == "SAR" ]; then
        for SHOT in "${SHOT_VERSIONS[@]}"; do
          if [ "$TYPE" == "SAR" ]; then
            INPUT_PATH="data/batch/gpt-4o-mini/${YEAR}/processed/batch_SAR_${SHOT}_run${RUN}.jsonl"
            TREC_FILE="data/results/trec_files/ance_batch_SAR_${SHOT}_run${RUN}_ttype_reformulate.trec"

            echo "Processing Type: $TYPE, Shot: $SHOT, Run: $RUN, Year: $YEAR"

            # Execute the processing command without --split_rewrite
            srun python -u pcir/ance_ikat.py \
              --config=pcir/ance_ikat_config.toml \
              --test_file_path "$INPUT_PATH" \
              --year "$YEAR" \

          else
            for PROMPT in "${PROMPTS[@]}"; do
              INPUT_PATH="data/batch/gpt-4o-mini/${YEAR}/processed/batch_LLM_${SHOT}_${PROMPT}_run${RUN}.jsonl"
              TREC_FILE="data/results/trec_files/ance_batch_LLM_${SHOT}_${PROMPT}_run${RUN}_ttype_reformulate.trec"

              echo "Processing Type: $TYPE, Shot: $SHOT, Run: $RUN, Prompt: $PROMPT, Year: $YEAR"

              # Execute the processing command with --split_rewrite
              srun python -u pcir/ance_ikat.py \
                --config=pcir/ance_ikat_config.toml \
                --test_file_path "$INPUT_PATH" \
                --year "$YEAR" \
                --split_rewrite
            done
          fi
        done
      elif [ "$TYPE" == "automatic" ]; then
        # Special case for "automatic" to use a different config file
        for PROMPT in "${PROMPTS[@]}"; do
          INPUT_PATH="data/batch/gpt-4o-mini/${YEAR}/processed/batch_${TYPE}_0shot_${PROMPT}_run${RUN}.jsonl"
          TREC_FILE="data/results/trec_files/ance_batch_${TYPE}_0shot_${PROMPT}_run${RUN}_ttype_reformulate.trec"

          echo "Processing Type: $TYPE, Run: $RUN, Prompt: $PROMPT, Year: $YEAR"

          # Execute the processing command with --split_rewrite
          srun python -u pcir/ance_ikat.py \
            --config=pcir/ance_ikat_config_automatic.toml \
            --test_file_path "$INPUT_PATH" \
            --year "$YEAR" \
            --split_rewrite
        done
      else
        # Default case for types without multiple shot versions
        for PROMPT in "${PROMPTS[@]}"; do
          INPUT_PATH="data/batch/gpt-4o-mini/${YEAR}/processed/batch_${TYPE}_0shot_${PROMPT}_run${RUN}.jsonl"
          TREC_FILE="data/results/trec_files/ance_batch_${TYPE}_0shot_${PROMPT}_run${RUN}_ttype_reformulate.trec"

          echo "Processing Type: $TYPE, Shot: 0shot, Run: $RUN, Prompt: $PROMPT, Year: $YEAR"

          # Execute the processing command with --split_rewrite
          srun python -u pcir/ance_ikat.py \
            --config=pcir/ance_ikat_config.toml \
            --test_file_path "$INPUT_PATH" \
            --year "$YEAR" \
            --split_rewrite
        done
      fi
    done
  done
done
